<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Project Panel Selection Detection</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #2b2b2b;
            color: #e0e0e0;
            padding: 20px;
        }

        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            font-size: 18px;
            margin-bottom: 20px;
            color: #4ec9b0;
        }

        .status-box {
            background: #1e1e1e;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .status-label {
            font-size: 12px;
            color: #808080;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            font-size: 14px;
            color: #4ec9b0;
            font-weight: 600;
        }

        .clip-info {
            background: #252525;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .clip-info h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #4fc3f7;
        }

        .info-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 12px;
        }

        .info-label {
            color: #808080;
            min-width: 120px;
        }

        .info-value {
            color: #e0e0e0;
            word-break: break-all;
        }

        .log {
            background: #1a1a1a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            padding: 12px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .log-entry {
            margin-bottom: 4px;
            color: #d0d0d0;
        }

        .log-timestamp {
            color: #808080;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-error {
            color: #f48771;
        }

        .log-info {
            color: #4fc3f7;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        button {
            padding: 10px 16px;
            background: #0078d4;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #005a9e;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #3a3a3a;
        }

        .btn-secondary:hover {
            background: #454545;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç Project Panel Selection Detection Test</h1>

        <div class="status-box">
            <div class="status-label">CEP Interface Status</div>
            <div class="status-value" id="cepStatus">Initializing...</div>
        </div>

        <div class="controls">
            <button id="startPolling">Start Monitoring</button>
            <button id="stopPolling" class="btn-secondary" disabled>Stop Monitoring</button>
            <button id="checkNow" class="btn-secondary">Check Selection Now</button>
            <button id="clearLog" class="btn-secondary">Clear Log</button>
        </div>

        <div class="status-box">
            <div class="status-label">Polling Status</div>
            <div class="status-value" id="pollingStatus">Not started</div>
        </div>

        <div id="currentClipContainer"></div>

        <h3 style="font-size: 14px; margin-bottom: 12px; color: #b0b0b0;">Event Log</h3>
        <div class="log" id="eventLog"></div>
    </div>

    <script type="text/javascript" src="js/CSInterface.js"></script>
    <script type="text/javascript">
        (function() {
            'use strict';

            // ========================================
            // INITIALIZATION
            // ========================================

            var csInterface;
            var pollingInterval = null;
            var lastSelectedNodeId = null;
            var pollCount = 0;

            // DOM elements
            var cepStatus = document.getElementById('cepStatus');
            var pollingStatus = document.getElementById('pollingStatus');
            var currentClipContainer = document.getElementById('currentClipContainer');
            var eventLog = document.getElementById('eventLog');
            var startPollingBtn = document.getElementById('startPolling');
            var stopPollingBtn = document.getElementById('stopPolling');
            var checkNowBtn = document.getElementById('checkNow');
            var clearLogBtn = document.getElementById('clearLog');

            // Initialize CSInterface
            try {
                csInterface = new CSInterface();
                cepStatus.textContent = '‚úì Connected to Premiere Pro';
                cepStatus.style.color = '#4ec9b0';
                log('CSInterface initialized successfully', 'success');

                // Load ExtendScript
                loadExtendScript();
            } catch (e) {
                cepStatus.textContent = '‚úó Failed to initialize';
                cepStatus.style.color = '#f48771';
                log('CSInterface initialization failed: ' + e.message, 'error');
            }

            // ========================================
            // LOGGING
            // ========================================

            function log(message, type) {
                var timestamp = new Date().toLocaleTimeString();
                var entry = document.createElement('div');
                entry.className = 'log-entry log-' + (type || 'info');
                entry.innerHTML = '<span class="log-timestamp">[' + timestamp + ']</span> ' + message;
                eventLog.appendChild(entry);
                eventLog.scrollTop = eventLog.scrollHeight;
                console.log('[' + type + '] ' + message);
            }

            // ========================================
            // EXTENDSCRIPT LOADING
            // ========================================

            function loadExtendScript() {
                log('Loading ExtendScript (host.jsx)...', 'info');

                var extensionPath = csInterface.getSystemPath(SystemPath.EXTENSION);
                var jsxPath = extensionPath + '/jsx/host.jsx';

                csInterface.evalScript('$.evalFile("' + jsxPath + '")', function(result) {
                    log('ExtendScript evalFile completed', 'info');

                    // Verify EAVIngest module exists
                    csInterface.evalScript('typeof EAVIngest', function(typeResult) {
                        if (typeResult === 'object') {
                            log('‚úì EAVIngest module loaded successfully', 'success');
                        } else {
                            log('‚úó EAVIngest module failed to load (type: ' + typeResult + ')', 'error');
                        }
                    });
                });
            }

            // ========================================
            // SELECTION DETECTION
            // ========================================

            function checkSelection() {
                pollCount++;

                csInterface.evalScript('EAVIngest.getSelectedClips()', function(result) {
                    try {
                        var data = JSON.parse(result);

                        if (data.error) {
                            // No selection or error
                            if (lastSelectedNodeId !== null) {
                                log('Selection cleared', 'info');
                                lastSelectedNodeId = null;
                                displayNoSelection();
                            }
                            return;
                        }

                        if (data.clips && data.clips.length > 0) {
                            var clip = data.clips[0]; // First selected clip

                            // Check if this is a NEW selection
                            if (clip.nodeId !== lastSelectedNodeId) {
                                log('‚úì NEW CLIP SELECTED: ' + clip.name, 'success');
                                lastSelectedNodeId = clip.nodeId;
                                displayClipInfo(clip);

                                // Automatically open in Source Monitor
                                openInSourceMonitor(clip.nodeId);
                            }
                        }
                    } catch (e) {
                        log('Parse error: ' + e.message, 'error');
                    }
                });
            }

            function openInSourceMonitor(nodeId) {
                log('Opening clip in Source Monitor...', 'info');
                csInterface.evalScript('EAVIngest.openInSourceMonitor("' + nodeId + '")', function(result) {
                    try {
                        var data = JSON.parse(result);
                        if (data.success) {
                            log('‚úì Clip opened in Source Monitor', 'success');
                        } else {
                            log('‚úó Failed to open in Source Monitor: ' + data.error, 'error');
                        }
                    } catch (e) {
                        log('Failed to parse openInSourceMonitor result', 'error');
                    }
                });
            }

            function displayClipInfo(clip) {
                currentClipContainer.innerHTML = `
                    <div class="clip-info">
                        <h3>Currently Selected Clip</h3>
                        <div class="info-row">
                            <div class="info-label">Name:</div>
                            <div class="info-value">${clip.name || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Node ID:</div>
                            <div class="info-value">${clip.nodeId || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Tree Path:</div>
                            <div class="info-value">${clip.treePath || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Media Path:</div>
                            <div class="info-value">${clip.mediaPath || 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Duration:</div>
                            <div class="info-value">${clip.duration ? clip.duration.toFixed(2) + 's' : 'N/A'}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">Existing Metadata:</div>
                            <div class="info-value">Tape: ${clip.tapeName || '(empty)'}, Desc: ${clip.description || '(empty)'}, Shot: ${clip.shot || '(empty)'}</div>
                        </div>
                    </div>
                `;
            }

            function displayNoSelection() {
                currentClipContainer.innerHTML = `
                    <div class="clip-info">
                        <h3>No Clip Selected</h3>
                        <p style="color: #808080; font-size: 12px;">Click on a clip in the Project Panel to test detection.</p>
                    </div>
                `;
            }

            // ========================================
            // POLLING CONTROL
            // ========================================

            function startPolling() {
                if (pollingInterval) return;

                log('Started monitoring Project Panel selection (polling every 500ms)', 'info');
                pollingStatus.textContent = 'Monitoring active (Poll #' + pollCount + ')';
                pollingStatus.style.color = '#4ec9b0';

                startPollingBtn.disabled = true;
                stopPollingBtn.disabled = false;

                pollingInterval = setInterval(function() {
                    checkSelection();
                    pollingStatus.textContent = 'Monitoring active (Poll #' + pollCount + ')';
                }, 500);
            }

            function stopPolling() {
                if (!pollingInterval) return;

                clearInterval(pollingInterval);
                pollingInterval = null;

                log('Stopped monitoring', 'info');
                pollingStatus.textContent = 'Monitoring stopped';
                pollingStatus.style.color = '#808080';

                startPollingBtn.disabled = false;
                stopPollingBtn.disabled = true;
            }

            // ========================================
            // EVENT LISTENERS
            // ========================================

            startPollingBtn.addEventListener('click', startPolling);
            stopPollingBtn.addEventListener('click', stopPolling);
            checkNowBtn.addEventListener('click', function() {
                log('Manual selection check triggered', 'info');
                checkSelection();
            });
            clearLogBtn.addEventListener('click', function() {
                eventLog.innerHTML = '';
                log('Log cleared', 'info');
            });

            // ========================================
            // INITIALIZE
            // ========================================

            displayNoSelection();
            log('Test panel ready. Click "Start Monitoring" to begin.', 'info');

        })();
    </script>
</body>
</html>
